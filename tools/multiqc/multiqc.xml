
<tool id="multiqc" name="multiqc" version="0.6">
    <description>aggregate results from bioinformatics analyses across many samples into a single report</description>
    <requirements>
       <requirement type="package" version="0.6">multiqc</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command>
        mkdir dir;
        #for $i, $file in enumerate( $results )
          #if $file.software == "fastqc"

              ## create a directory for this repeat
              mkdir dir/fastqc_${i};

              #for $k, $onefile in enumerate ( $file.input_file )
                  ## create a directory for each file
                  mkdir dir/fastqc_${i}/$k;
                  cat ${onefile} > dir/fastqc_${i}/$k/fastqc_data.txt;
              #end for           

          #else if $file.software == "tophat"
              #for $onefile in $file.input_file
                  ## test input file
                  if [[ '${onefile.display_name}' =~ align_summary$ ]]; then cat ${onefile} > dir/'${onefile.display_name}'.txt; else cat ${onefile} > dir/'${onefile.display_name}'_align_summary.txt; fi;
              #end for

          #else if $file.software == "cutadapt"
              #for $onefile in $file.input_file
                  cat ${onefile} > dir/'${onefile.display_name}'.txt;
                  ## replace header for old cutadapt release
                  sed -i 's/You are running/This is/' dir/'${onefile.display_name}'.txt;               
              #end for

          #else if $file.software == "featurecounts"
              #for $onefile in $file.input_file
                  ## remove spaces and coton to skip multiqc crash
                  cat ${onefile} > dir/featurecounts_result.summary;
                  ## remove spaces and coton to skip multiqc crash
                  sed -i 's/:/_/g' dir/featurecounts_result.summary;
                  sed -i 's/ /_/g' dir/featurecounts_result.summary;
              #end for
          #else
              #for $onefile in $file.input_file
                  cat ${onefile} > dir/'${onefile.display_name}';
              #end for 
         #end if
        #end for

        multiqc dir; 
       
    </command>
    <inputs>
        <!--param name="inputs" type="data" format="txt" multiple="true" label="Tools logs-outputs" /-->
        <repeat name="results" title="Results" min="1">
                <param name="software" type="select" label="Software name">
                     <options from_data_table="multiqc_indexes">
                           <filter type="sort_by" column="1" />
                           <validator type="no_options" message="No indexes are available" />
                      </options>
                </param>
                <param name="input_file" type="data" format="txt, tabular" multiple="true" label="Result file" />
        </repeat>
    </inputs>
    <outputs>
        <data format="html" from_work_dir="multiqc_report.html" name="html_file" label="${tool.name} on ${on_string}: Webpage" />
        <data format="txt" name="text_file" from_work_dir="multiqc_data/.multiqc.log" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <help>
MultiQC aggregates results from bioinformatics analyses across many samples into a single report
MultiQC searches a given directory for analysis logs and compiles a HTML report. It's a general use tool, perfect for summarising the output from numerous bioinformatics tools.
    </help>
</tool>

