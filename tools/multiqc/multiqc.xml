<tool id="multiqc" name="multiqc" version="0.6">
    <description>aggregate results from bioinformatics analyses across many samples into a single report</description>
    <requirements>
       <requirement type="package" version="0.6">multiqc</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command>
        mkdir multiqc_WDir;
        
        #for $i, $repeat in enumerate( $results )

          mkdir multiqc_WDir/${repeat.software}_${i};

          #if $repeat.software == "fastqc"

              #for $k, $file in enumerate ( $repeat.input_file )
                  ## create a directory for each file because of the unqiue name file parsing
                  mkdir multiqc_WDir/${repeat.software}_${i}/file_${k};
                  cat ${file} > multiqc_WDir/${repeat.software}_${i}/file_$k/fastqc_data.txt;
              #end for           

          #else if $repeat.software == "tophat"

              #for $file in $repeat.input_file
                  ## test if input file name contains align_summary
                  if [[ '${file.display_name}' =~ align_summary$ ]]; then
                       cat ${file} > multiqc_WDir/${repeat.software}_${i}/'${file.display_name}'.txt; else
                       cat ${file} > multiqc_WDir/${repeat.software}_${i}/'${file.display_name}'_align_summary.txt; 
                  fi;
              #end for

          #else if $repeat.software == "cutadapt"

              #for $file in $repeat.input_file
                  cat ${file} > multiqc_WDir/${repeat.software}_${i}/'${file.display_name}'.txt;
                  ## replace header for old cutadapt release
                  sed -i 's/You are running/This is/' multiqc_WDir/${repeat.software}_${i}/'${file.display_name}'.txt;               
              #end for

          #else if $repeat.software == "featurecounts"

              #for $file in $repeat.input_file
                  ## remove spaces and colon to skip multiqc crash
                  cat ${file} > multiqc_WDir/${repeat.software}_${i}/featurecounts_result.summary;
                  ## remove spaces and colon to skip multiqc crash
                  sed -i 's/:/_/g' multiqc_WDir/${repeat.software}_${i}/featurecounts_result.summary;
                  sed -i 's/ /_/g' multiqc_WDir/${repeat.software}_${i}/featurecounts_result.summary;
              #end for
          #else
              #for $file in $repeat.input_file
              cat ${file} > multiqc_WDir/${repeat.software}_${i}/'${file.display_name}';
                  #if $repeat.software == "picard"
		      sed -i 's/picard.sam.markduplicates.MarkDuplicates/picard.sam.MarkDuplicates/' multiqc_WDir/${repeat.software}_${i}/'${file.display_name}';                
		  #end if
              #end for 
         #end if
        #end for

        multiqc multiqc_WDir; 
       
    </command>
    <inputs>
        <!--param name="inputs" type="data" format="txt" multiple="true" label="Tools logs-outputs" /-->
        <repeat name="results" title="Results" min="1">
                <param name="software" type="select" label="Software name">
                     <options from_data_table="multiqc_indexes">
                           <filter type="sort_by" column="1" />
                           <validator type="no_options" message="No indexes are available" />
                      </options>
                </param>
                <param name="input_file" type="data" format="txt, tabular" multiple="true" label="Result file" />
        </repeat>
    </inputs>
    <outputs>
        <data format="html" from_work_dir="multiqc_report.html" name="html_file" label="${tool.name} on ${on_string}: Webpage" />
        <data format="txt" name="text_file" from_work_dir="multiqc_data/.multiqc.log" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <help>
**What it does**

MultiQC aggregates results from bioinformatics analyses across many samples into a single report

----

**Description**

MultiQC searches a given directory for analysis logs and compiles a HTML report. It's a general use tool, perfect for summarising the output from numerous bioinformatics tools.

----

**Inputs**

MultiQC takes software outputs summary in order to create a single report. Below a list of Galaxy tools compatible:

  - Tophat
  - Fastqc
  - Samtools stats
  - Cutadapt
  - FeatureCounts
  - Bowtie2
  - SnpEff

    </help>
</tool>

